import { Component, OnInit } from '@angular/core';
import { CarsService } from 'src/app/_services/cars.service';
import { AccountService } from 'src/app/_services/account.service';
import { User } from 'src/app/_models/user';
import { take } from 'rxjs/operators';
import { Car } from 'src/app/_models/car';
import { ToastrService } from 'ngx-toastr';
import { Observable } from 'rxjs';
import { AudiMark, BMWMark, LexusMark, MarkEnum, MercedesMark, Marks } from 'src/app/_enums/cars-data';

@Component({
  selector: 'app-car-card',
  templateUrl: './car-card.component.html',
  styleUrls: ['./car-card.component.css'],
})
export class CarCardComponent implements OnInit {
  user: User;
  cars$: Observable <Car[]>; 
  car: Car;
  public Marks = MarkEnum;
  yearProduction:Number[];
  enumKeys = [];
  carModels:string[];
  carsToRemove: Array<Number> = new Array;

  constructor(private _accoutService: AccountService, private _carsService: CarsService, private _toastr: ToastrService) { 
    this._accoutService.currentUser$.pipe(take(1)).subscribe(user => this.user = user);
    this.enumKeys = Object.keys(this.Marks).filter(f => !isNaN(Number(f)));
    this.setYearProduction();
  }

  ngOnInit(): void {
    this.readUserCars();
  }
  addUserCar(){
    let model, mark:string;
    let yearProduction, costBuy, mileage: Number;
    let newCar: Car; 
    mark = Marks[(<HTMLSelectElement>document.getElementById('mark')).value];
    model = (<HTMLSelectElement>document.getElementById('model')).value;
    costBuy = parseInt((<HTMLInputElement>document.getElementById('costBuy')).value);  
    yearProduction = parseInt((<HTMLInputElement>document.getElementById('yearProduction')).value);  
    mileage = parseInt((<HTMLInputElement>document.getElementById('mileage')).value);  
    newCar = {appUserId: 1, mark: mark, model: model, yearProduction:yearProduction, buyCost: costBuy, mileage: mileage};
    console.log(yearProduction);
    this._carsService.addUserCar(newCar);
  }
  readUserCars(){ 
    this.cars$ = this._carsService.getUserCars("lisa");//this.user
  }
  deleteUserCars(){
    console.log("removing");
    for(let i = 0; i < this.carsToRemove.length; i++)
    {
      this._carsService.deleteUserCar(this.carsToRemove[i]);      
    }
    this.readUserCars();
  }
  onSelect(markEnum)
  {
    switch(+markEnum)
    {
      case MarkEnum.Audi:     this.carModels = AudiMark;     break;
      case MarkEnum.Mercedes: this.carModels = MercedesMark; break;
      case MarkEnum.Lexus:    this.carModels = LexusMark;    break;
      case MarkEnum.BMW:      this.carModels = BMWMark;     break;
    }    
  }
  setYearProduction()
  {
    var currentYear = new Date().getFullYear();
    this.yearProduction= Array.from(Array(currentYear - 1979).keys()).map(x => x + 1980);
  }
  addCarToRemove(id: number)//
  {
    console.log(id);
    this.carsToRemove.push(id);
  }
}
